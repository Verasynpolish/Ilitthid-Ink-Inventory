<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Illithid Ink — Pigment & Supply Inventory</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#111318; --muted:#8a91a5; --text:#e8ecf1; --accent:#8bd3ff; --chip:#1a1e27; --border:#1f2430; --good:#7ecb92; --warn:#ffd78b;
    }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0a0c12,#0e1016 30%,#0b0c10);color:var(--text)}
    .container{max-width:1280px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;z-index:10;background:rgba(11,12,16,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .header-inner{display:flex;gap:16px;align-items:center;flex-wrap:wrap;padding:14px 0}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.3px}
    .logo{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 220deg at 50% 50%, #7cf, #a7f, #5ff, #7cf); box-shadow:0 0 24px rgba(139,211,255,.35) inset}
    .search{flex:1;min-width:260px}
    .search input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0f1218;color:var(--text);outline:none}
    .controls{display:flex;gap:12px;flex-wrap:wrap}
    .control{display:flex;gap:8px;align-items:center;background:var(--panel);padding:8px 10px;border-radius:12px;border:1px solid var(--border)}
    .control label{font-size:12px;color:var(--muted)}
    select, .pill{background:#0f1218;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin:18px 0 8px;gap:12px;flex-wrap:wrap}
    .btn{cursor:pointer;display:inline-flex;gap:8px;align-items:center;background:#111826;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px}
    .btn:hover{border-color:#2b3444}
    .count{font-size:12px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden;transition:.2s transform,.2s box-shadow}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(0,0,0,.25)}
    .imgwrap{aspect-ratio:4/3;background:#0d1117;display:flex;align-items:center;justify-content:center}
    .imgwrap img{max-width:100%;max-height:100%;object-fit:contain}
    .card-body{padding:12px}
    .name{font-weight:700;font-size:15px;line-height:1.25;margin:0 0 6px}
    .meta{font-size:12px;color:var(--muted)}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .chip{font-size:11px;padding:4px 8px;background:var(--chip);border:1px solid var(--border);border-radius:999px;color:#cfe7ff}
    .price{margin-top:8px;font-size:13px}
    .price strong{font-weight:700}
    .kpis{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
    .kpis span{background:#0f1218;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
    .kpis .ok{color:var(--good)}

    .footer{margin:36px 0 24px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.visually-hidden-file{position:absolute;left:-9999px;width:1px;height:1px;opacity:0}
    .sr-only{position:absolute;left:-10000px}
    .warn{color:var(--warn)}
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <div class="brand" title="Illithid Ink">
        <div class="logo" aria-hidden="true"></div>
        <span>Illithid Ink · Pigment & Supply Inventory</span>
      </div>
      <div class="search">
        <label class="sr-only" for="q">Search</label>
        <input id="q" type="search" placeholder="Search name, vendor, notes, order ID… (e.g., 'Ultra Aurora', 'Just Pigments', '54021')" />
      </div>
      <div class="controls">
        <div class="control">
          <label for="vendor">Vendor</label>
          <select id="vendor" multiple size="1" title="Filter by vendor"></select>
        </div>
        <div class="control">
          <label for="category">Category</label>
          <select id="category" multiple size="1" title="Filter by category"></select>
        </div>
        <div class="control">
          <label for="finish">Type/Finish</label>
          <select id="finish" multiple size="1" title="Filter by type/finish"></select>
        </div>
        <div class="control">
          <label for="sort">Sort</label>
          <select id="sort" title="Sort">
            <option value="name">Name (A→Z)</option>
            <option value="cpgram_asc">Cost/gram (low→high)</option>
            <option value="cpgram_desc">Cost/gram (high→low)</option>
            <option value="date_desc">Newest first</option>
            <option value="date_asc">Oldest first</option>
          </select>
        </div>
        <button class="btn" id="clear">Clear filters</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="toolbar">
      <div class="count" id="count">0 items</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input type="file" id="importCsv" accept=".csv" class="visually-hidden-file" />
<label class="btn" id="importLabel" for="importCsv" title="Import CSV">Import CSV</label>
<div id="dropZone" style="border:1px dashed var(--border);border-radius:10px;padding:8px 10px;font-size:12px;color:var(--muted)">or drop a CSV file here</div>
        <button class="btn" id="exportBtn" title="Export current view to CSV">Export CSV</button>
        <button class="btn" id="saveJson" title="Download inventory.json">Download JSON</button>
      </div>
    </div>

    <div class="kpis">
      <span id="kpi_total_items">Total items: 0</span>
      <span id="kpi_total_cost">Total spend: $0.00</span>
      <span id="kpi_total_weight">Total weight: 0 g</span>
      <span id="kpi_avg_cpg">Avg $/g: $0.00</span>
    </div>

    <div class="grid" id="grid" aria-live="polite"></div>

    <div class="footer">
      <div>Tip: Hold <kbd>Ctrl</kbd>/<kbd>Cmd</kbd> to select multiple filters. Use CSV import to bulk‑load your inventory (schema below).</div>
      <div><a href="https://github.com/new" target="_blank" rel="noopener">Deploy to GitHub Pages</a></div>
    </div>

    <details class="container" style="margin-top:8px">
      <summary>CSV schema & example</summary>
      <pre style="white-space:pre-wrap;line-height:1.4;color:#cfe7ff;background:#0f1218;border:1px solid var(--border);padding:12px;border-radius:12px;overflow:auto">Required columns (case-insensitive):
name,vendor,category,finish,color,particle_size_microns,solvent_safe,weight_g,volume_ml,price_usd,order_id,order_date,location,notes,image_url

• weight_g and price_usd → cost_per_gram auto-calculated
• If you only know ounces, put the converted grams in weight_g (1 oz = 28.3495 g)
• If item is a base/liquid sold by volume, you can leave weight_g blank—cost/gram will be N/A
• order_date format recommended: YYYY-MM-DD

Example CSV rows:
name,vendor,category,finish,color,particle_size_microns,solvent_safe,weight_g,volume_ml,price_usd,order_id,order_date,location,notes,image_url
"Ultra Aurora 06","Glitter Unique","Pigment","Interference","Blue","10-20",TRUE,5,,14.99,"GU-88231","2025-08-10","Pigments Bin A","fine overlay shimmer","images/ua06.jpg"
"Spectraflair 35","Spectraflair4u","Special Effect","Holographic","Silver","35",TRUE,2,,18.00,"S4U-12071","2025-08-31","Special FX","premixed carrier","images/sf35.jpg"
"Fine White Satin","Just Pigments","Pigment","Pearl","White","5-25",TRUE,30,,9.95,"JP-54021","2025-08-24","JP Drawer","","images/jp_white_satin.jpg"
"Glitter Suspension Base","Glitter Unique","Base","Suspension","Clear","","",,118,12.50,"GU-88231","2025-08-10","Bases Shelf","1/4 pint bottle","images/gu_base.jpg"
</pre>
    </details>
  </main>

  <script>
    // === 1) DATA MODEL ===
    // Inventory item shape:
    // {
    //   id, name, vendor, category, finish, color, particle_size_microns,
    //   solvent_safe (boolean), weight_g (number), volume_ml (number),
    //   price_usd (number), order_id, order_date (YYYY-MM-DD), location,
    //   notes, image_url
    // }

    const SAMPLE_DATA = [
      { id:"ua06", name:"Ultra Aurora 06", vendor:"Glitter Unique", category:"Pigment", finish:"Interference", color:"Blue", particle_size_microns:"10-20", solvent_safe:true, weight_g:5, volume_ml:null, price_usd:14.99, order_id:"GU-88231", order_date:"2025-08-10", location:"Pigments Bin A", notes:"fine overlay shimmer", image_url:"images/ua06.jpg" },
      { id:"sf35", name:"Spectraflair 35", vendor:"Spectraflair4u", category:"Special Effect", finish:"Holographic", color:"Silver", particle_size_microns:"35", solvent_safe:true, weight_g:2, volume_ml:null, price_usd:18.00, order_id:"S4U-12071", order_date:"2025-08-31", location:"Special FX", notes:"premixed carrier", image_url:"images/sf35.jpg" },
      { id:"jp_white_satin", name:"Fine White Satin", vendor:"Just Pigments", category:"Pigment", finish:"Pearl", color:"White", particle_size_microns:"5-25", solvent_safe:true, weight_g:30, volume_ml:null, price_usd:9.95, order_id:"JP-54021", order_date:"2025-08-24", location:"JP Drawer", notes:"", image_url:"images/jp_white_satin.jpg" },
      { id:"gu_base_quartpint", name:"Glitter Suspension Base", vendor:"Glitter Unique", category:"Base", finish:"Suspension", color:"Clear", particle_size_microns:"", solvent_safe:"", weight_g:null, volume_ml:118, price_usd:12.50, order_id:"GU-88231", order_date:"2025-08-10", location:"Bases Shelf", notes:"1/4 pint bottle", image_url:"images/gu_base.jpg" }
    ];

    // === 2) STATE ===
    let DB = [...SAMPLE_DATA];
    const state = { q:"", vendor:[], category:[], finish:[], sort:"name" };

    // === 3) HELPERS ===
    const $ = sel => document.querySelector(sel);
    const fmtUSD = n => isFinite(n) ? `$${n.toFixed(2)}` : '—';
    const parseNum = v => v==null || v==="" ? null : Number(v);
    const uniq = arr => [...new Set(arr)].sort((a,b)=>String(a).localeCompare(String(b)));

    function costPerGram(item){
      const price = parseNum(item.price_usd);
      const g = parseNum(item.weight_g);
      if(price!=null && g!=null && g>0) return price/g;
      return null;
    }

    function totalSpend(rows){
      return rows.reduce((s,r)=>s+(parseNum(r.price_usd)||0),0);
    }

    function totalWeight(rows){
      return rows.reduce((s,r)=>s+(parseNum(r.weight_g)||0),0);
    }

    function normalize(str){ return (str||"").toString().toLowerCase(); }

    function filterDB(){
      const q = normalize(state.q);
      let rows = DB.filter(it=>{
        const hay = [it.name,it.vendor,it.category,it.finish,it.color,it.particle_size_microns,it.order_id,it.location,it.notes].map(normalize).join(' ');
        const matchQ = !q || hay.includes(q);
        const matchVendor = !state.vendor.length || state.vendor.includes(it.vendor);
        const matchCat = !state.category.length || state.category.includes(it.category);
        const matchFin = !state.finish.length || state.finish.includes(it.finish);
        return matchQ && matchVendor && matchCat && matchFin;
      });

      // sort
      rows.sort((a,b)=>{
        if(state.sort==='name') return String(a.name).localeCompare(String(b.name));
        if(state.sort==='cpgram_asc') return (costPerGram(a)||Infinity) - (costPerGram(b)||Infinity);
        if(state.sort==='cpgram_desc') return (costPerGram(b)||-Infinity) - (costPerGram(a)||-Infinity);
        if(state.sort==='date_desc') return String(b.order_date||'').localeCompare(String(a.order_date||''));
        if(state.sort==='date_asc') return String(a.order_date||'').localeCompare(String(b.order_date||''));
        return 0;
      });

      return rows;
    }

    function populateFilters(){
      const vendors = uniq(DB.map(x=>x.vendor).filter(Boolean));
      const cats = uniq(DB.map(x=>x.category).filter(Boolean));
      const fins = uniq(DB.map(x=>x.finish).filter(Boolean));
      optionize($('#vendor'), vendors);
      optionize($('#category'), cats);
      optionize($('#finish'), fins);
    }

    function optionize(select, values){
      select.innerHTML = "";
      for(const v of values){ const opt=document.createElement('option'); opt.value=v; opt.textContent=v; select.appendChild(opt); }
    }

    function render(){
      const grid = $('#grid');
      grid.innerHTML = '';
      const data = filterDB();
      $('#count').textContent = `${data.length} item${data.length!==1?'s':''}`;

      // KPIs
      const spend = totalSpend(data);
      const wt = totalWeight(data);
      const avg = data.length ? (data.reduce((s,r)=>{ const c=costPerGram(r); return s+(c||0); },0) / data.filter(r=>costPerGram(r)!=null).length) : 0;
      $('#kpi_total_items').textContent = `Total items: ${data.length}`;
      $('#kpi_total_cost').textContent = `Total spend: ${fmtUSD(spend)}`;
      $('#kpi_total_weight').textContent = `Total weight: ${wt.toFixed(2)} g`;
      $('#kpi_avg_cpg').textContent = `Avg $/g: ${isFinite(avg)?`$${avg.toFixed(2)}`:'—'}`;

      data.forEach(item=>{
        const cpg = costPerGram(item);
        const card = document.createElement('article'); card.className='card';
        const imgwrap = document.createElement('div'); imgwrap.className='imgwrap';
        const img = document.createElement('img'); img.loading='lazy'; img.alt=`${item.vendor} — ${item.name}`; img.src=item.image_url||''; imgwrap.appendChild(img);
        const body = document.createElement('div'); body.className='card-body';
        const name = document.createElement('h3'); name.className='name'; name.textContent = item.name;
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${item.vendor} • ${item.category}${item.finish?` • ${item.finish}`:''}`;
        const chips = document.createElement('div'); chips.className='chips';
        if(item.color){ const s=document.createElement('span'); s.className='chip'; s.textContent=item.color; chips.appendChild(s); }
        if(item.particle_size_microns){ const s=document.createElement('span'); s.className='chip'; s.textContent=`${item.particle_size_microns}µm`; chips.appendChild(s); }
        if(item.solvent_safe===true){ const s=document.createElement('span'); s.className='chip'; s.textContent='Solvent‑safe'; chips.appendChild(s); }
        if(item.location){ const s=document.createElement('span'); s.className='chip'; s.textContent=item.location; chips.appendChild(s); }

        const price = document.createElement('div'); price.className='price';
        price.innerHTML = `${item.weight_g?`<strong>${item.weight_g} g</strong>`:''}${item.volume_ml?`${item.weight_g?' · ':''}<strong>${item.volume_ml} ml</strong>`:''}${(item.weight_g||item.volume_ml)?' · ':''}${item.price_usd!=null?fmtUSD(Number(item.price_usd)):'—'}${cpg!=null?` · <span title="cost per gram"><strong>${fmtUSD(cpg)}</strong>/g</span>`:' · <span class="warn" title="Need weight_g to compute $/g">$/g N/A</span>'}`;

        const kpis = document.createElement('div'); kpis.className='kpis';
        const oid = document.createElement('span'); oid.textContent = `Order: ${item.order_id||'—'}`; kpis.appendChild(oid);
        const od = document.createElement('span'); od.textContent = `Date: ${item.order_date||'—'}`; kpis.appendChild(od);
        if(item.notes){ const n=document.createElement('span'); n.textContent=`Note: ${item.notes}`; kpis.appendChild(n); }

        body.append(name, meta, chips, price, kpis);
        card.append(imgwrap, body);
        grid.appendChild(card);
      });
    }

    function initEvents(){
      $('#q').addEventListener('input', e=>{ state.q=e.target.value; render(); });
      for(const [id,key] of [['#vendor','vendor'],['#category','category'],['#finish','finish']]){
        $(id).addEventListener('change', e=>{
          state[key] = Array.from(e.target.selectedOptions).map(o=>o.value);
          render();
        });
      }
      $('#sort').addEventListener('change', e=>{ state.sort=e.target.value; render(); });
      $('#clear').addEventListener('click', ()=>{
        state.q=''; state.vendor=[]; state.category=[]; state.finish=[]; $('#q').value='';
        for(const id of ['#vendor','#category','#finish']) $(id).selectedIndex=-1;
        $('#sort').value='name'; state.sort='name';
        render();
      });

      $('#exportBtn').addEventListener('click', exportCSV);
      // (button removed; using label + hidden input and drop zone)
// drag & drop support added below
      $('#importCsv').addEventListener('change', handleImportCSV);
      $('#saveJson').addEventListener('click', downloadJSON);
    }

    function toCSV(rows){
      const headers = ["name","vendor","category","finish","color","particle_size_microns","solvent_safe","weight_g","volume_ml","price_usd","order_id","order_date","location","notes","image_url"];
      const esc = v=>`"${String(v??'').replace(/"/g,'""')}"`;
      const lines = [headers.join(',')];
      for(const r of rows){
        const obj = headers.map(h=>{
          let v = r[h];
          if(h==='solvent_safe'){ v = r[h]===true? 'TRUE' : r[h]===false? 'FALSE' : ''; }
          return esc(v);
        });
        lines.push(obj.join(','));
      }
      return lines.join('
');
    }

    function download(filename, text, type='text/plain'){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type}));
      a.download = filename; a.click();
    }

    function exportCSV(){
      const rows = filterDB();
      download('inventory_export.csv', toCSV(rows), 'text/csv');
    }

    function downloadJSON(){
      download('inventory.json', JSON.stringify(DB,null,2), 'application/json');
    }

    function parseCSV(text){
      // Simple CSV parser (no external libs). Assumes commas, quotes escaped by doubling.
      const lines = text.replace(//g,'').split('
').filter(l=>l.trim().length);
      const headers = lines.shift().split(',').map(h=>h.trim().toLowerCase());
      const idx = name=> headers.indexOf(name);
      const get = (arr,i)=> arr[i]!==undefined? arr[i] : '';
      const rows=[];
      for(const line of lines){
        const cells = [];
        let cur=''; let inQ=false; for(let i=0;i<line.length;i++){
          const ch=line[i];
          if(ch==='"'){
            if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
            else inQ=!inQ;
          } else if(ch===',' && !inQ){ cells.push(cur); cur=''; }
          else { cur+=ch; }
        }
        cells.push(cur);
        const row = (name)=> get(cells, idx(name));
        const obj = {
          id: crypto.randomUUID(),
          name: row('name'),
          vendor: row('vendor'),
          category: row('category'),
          finish: row('finish'),
          color: row('color'),
          particle_size_microns: row('particle_size_microns'),
          solvent_safe: (/^true$/i).test(row('solvent_safe')) ? true : (/^false$/i).test(row('solvent_safe')) ? false : '',
          weight_g: row('weight_g')? Number(row('weight_g')): null,
          volume_ml: row('volume_ml')? Number(row('volume_ml')): null,
          price_usd: row('price_usd')? Number(row('price_usd')): null,
          order_id: row('order_id'),
          order_date: row('order_date'),
          location: row('location'),
          notes: row('notes'),
          image_url: row('image_url'),
        };
        rows.push(obj);
      }
      return rows;
    }

    async function handleImportCSV(e){
  const file = e.target.files?.[0]; if(!file) return;
  await importFromFile(file);
  e.target.value = '';
}

async function importFromFile(file){
  const text = await file.text();
  try{
    const rows = parseCSV(text);
    DB = mergeByNameVendor(DB, rows);
    populateFilters();
    render();
    alert(`Imported ${rows.length} rows.`);
  }catch(err){
    console.error(err);
    alert('Import failed. Please check your CSV formatting.');
  }
}

    function mergeByNameVendor(oldRows, newRows){
      const key = r => `${(r.name||'').toLowerCase()}@@${(r.vendor||'').toLowerCase()}`;
      const map = new Map(oldRows.map(r=>[key(r), r]));
      for(const r of newRows){ map.set(key(r), r); }
      return Array.from(map.values());
    }

    function populateFromJSON(){ /* if you later host inventory.json, replace DB here via fetch */ }

    function init(){
      populateFilters();
      initEvents();
      render();
    }

    init();
  </script>
</body>
</html>
