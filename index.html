<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Illithid Ink — Pigment, Glitter & Powder Inventory</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#111318; --muted:#8a91a5; --text:#e8ecf1;
      --chip:#1a1e27; --border:#1f2430; --warn:#ffd78b;
    }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:#0b0c10;color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#111318;border-bottom:1px solid var(--border)}
    .container{max-width:1280px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .brand{font-weight:700}
    .search{flex:1;min-width:240px}
    .search input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0f1218;color:var(--text);outline:none}
    .control{display:flex;gap:8px;align-items:center;background:#111318;padding:8px 10px;border-radius:12px;border:1px solid var(--border)}
    .control label{font-size:12px;color:var(--muted)}
    select{background:#0f1218;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px;min-width:160px}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin:12px 0;gap:12px;flex-wrap:wrap}
    .count{font-size:12px;color:var(--muted)}
    .kpis{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin:6px 0 12px}
    .kpis span{background:#0f1218;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding-bottom:24px}
    .card{background:#111318;border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .imgwrap{aspect-ratio:4/3;background:#0d1117;display:flex;align-items:center;justify-content:center;color:#5b6a77}
    .imgwrap img{max-width:100%;max-height:100%;object-fit:contain}
    .card-body{padding:12px}
    .name{font-weight:700;font-size:15px;line-height:1.25;margin:0 0 6px}
    .meta{font-size:12px;color:var(--muted)}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .chip{font-size:11px;padding:4px 8px;background:var(--chip);border:1px solid var(--border);border-radius:999px;color:#cfe7ff}
    .price{margin-top:8px;font-size:13px}
    .warn{color:var(--warn)}
    .btn{cursor:pointer;display:inline-flex;gap:8px;align-items:center;background:#111826;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px}
    .btn:hover{border-color:#2b3444}
  </style>
</head>
<body>
  <header>
    <div class="container row">
      <div class="brand">Illithid Ink · Pigments · Glitters · Powders</div>
      <div class="search"><input id="q" type="search" placeholder="Search name, vendor, notes, order ID…" /></div>
      <div class="control">
        <label for="vendor">Vendor</label>
        <select id="vendor" multiple size="1"></select>
      </div>
      <div class="control">
        <label for="category">Category</label>
        <select id="category" multiple size="1"></select>
      </div>
      <div class="control">
        <label for="finish">Finish</label>
        <select id="finish" multiple size="1"></select>
      </div>
      <div class="control">
        <label for="sort">Sort</label>
        <select id="sort">
          <option value="name">Name (A→Z)</option>
          <option value="cpgram_asc">Cost/gram (low→high)</option>
          <option value="cpgram_desc">Cost/gram (high→low)</option>
          <option value="date_desc">Newest first</option>
          <option value="date_asc">Oldest first</option>
        </select>
      </div>
      <button class="btn" id="clear">Clear filters</button>
    </div>
  </header>

  <main class="container">
    <div class="toolbar">
      <div class="count" id="count">0 items</div>
    </div>

    <div class="kpis">
      <span id="kpi_total_items">Total items: 0</span>
      <span id="kpi_total_cost">Total spend: $0.00</span>
      <span id="kpi_total_weight">Total weight: 0 g</span>
      <span id="kpi_avg_cpg">Avg $/g: $0.00</span>
    </div>

    <div class="grid" id="grid" aria-live="polite"></div>
  </main>

  <script>
    // === Inline data (prices & locations blank) ===
    function halfOzToG(){ return 28.3495/2; } // 14.17475 g

    window.__INV__ = [
      /* --------- GLITTER UNIQUE (pigments & glitters only) --------- */
      {
        "id": "GU-UA06",
        "name": "Ultra Aurora 06",
        "vendor": "Glitter Unique",
        "category": "Pigment",
        "finish": "Interference",
        "color": "Blue",
        "particle_size_microns": "10–20",
        "solvent_safe": true,
        "weight_g": 5,
        "volume_ml": null,
        "price_usd": null,
        "order_id": "GU-88231",
        "order_date": "2025-08-10",
        "location": "",
        "notes": "fine overlay shimmer",
        "image_url": ""
      },
      {
        "id": "GU-IRID-BG-SQ035-1_2oz",
        "name": "Blue-Green Iridescent Square .035 — 1/2 oz",
        "vendor": "Glitter Unique",
        "category": "Glitter",
        "finish": "Iridescent",
        "color": "Blue/Green",
        "particle_size_microns": "",
        "solvent_safe": true,
        "weight_g": null,
        "volume_ml": null,
        "price_usd": null,
        "order_id": "45609",
        "order_date": "2025-08-25",
        "location": "",
        "notes": "SKU IRIDBGSQ035-0002",
        "image_url": ""
      },
      {
        "id": "GU-BLKHLSQ035-1_2oz",
        "name": "Black Holo Square .035 — 1/2 oz",
        "vendor": "Glitter Unique",
        "category": "Glitter",
        "finish": "Holographic",
        "color": "Black",
        "particle_size_microns": "",
        "solvent_safe": true,
        "weight_g": null,
        "volume_ml": null,
        "price_usd": null,
        "order_id": "45609",
        "order_date": "2025-08-25",
        "location": "",
        "notes": "SKU BLKHLSQ035-0002",
        "image_url": ""
      },
      {
        "id": "GU-IRID-PB-MicroShreds-1tsp",
        "name": "Purple-Blue Iridescent Micro Shreds — 1 tsp",
        "vendor": "Glitter Unique",
        "category": "Glitter",
        "finish": "Iridescent",
        "color": "Purple/Blue",
        "particle_size_microns": "",
        "solvent_safe": true,
        "weight_g": null,
        "volume_ml": null,
        "price_usd": null,
        "order_id": "45609",
        "order_date": "2025-08-25",
        "location": "",
        "notes": "SKU IRIDPBMSHR-0001",
        "image_url": ""
      },
      {
        "id": "GU-IRID-PB-H008-1_2oz",
        "name": "Purple-Blue Iridescent Hex .008 — 1/2 oz",
        "vendor": "Glitter Unique",
        "category": "Glitter",
        "finish": "Iridescent",
        "color": "Purple/Blue",
        "particle_size_microns": "",
        "solvent_safe": true,
        "weight_g": null,
        "volume_ml": null,
        "price_usd": null,
        "order_id": "45609",
        "order_date": "2025-08-25",
        "location": "",
        "notes": "SKU IRIDPRPH008-0002",
        "image_url": ""
      },
      {
        "id": "GU-IRID-PB-H015-1_2oz",
        "name": "Purple-Blue Iridescent Hex .015 — 1/2 oz",
        "vendor": "Glitter Unique",
        "category": "Glitter",
        "finish": "Iridescent",
        "color": "Purple/Blue",
        "particle_size_microns": "",
        "solvent_safe": true,
        "weight_g": null,
        "volume_ml": null,
        "price_usd": null,
        "order_id": "45609",
        "order_date": "2025-08-25",
        "location": "",
        "notes": "SKU IRIDPRPBH015-0002",
        "image_url": ""
      },
      {
        "id": "GU-IRID-PB-SQ035-1_2oz",
        "name": "Purple-Blue Iridescent Square .035 — 1/2 oz",
        "vendor": "Glitter Unique",
        "category": "Glitter",
        "finish": "Iridescent",
        "color": "Purple/Blue",
        "particle_size_microns": "",
        "solvent_safe": true,
        "weight_g": null,
        "volume_ml": null,
        "price_usd": null,
        "order_id": "45609",
        "order_date": "2025-08-25",
        "location": "",
        "notes": "SKU IRIDPRPSQ035-0002",
        "image_url": ""
      },
      {
        "id": "GU-SLV-HOLO-MicroShreds-1_2oz",
        "name": "Silver Holo Micro Shreds — 1/2 oz",
        "vendor": "Glitter Unique",
        "category": "Glitter",
        "finish": "Holographic",
        "color": "Silver",
        "particle_size_microns": "",
        "solvent_safe": true,
        "weight_g": null,
        "volume_ml": null,
        "price_usd": null,
        "order_id": "45609",
        "order_date": "2025-08-25",
        "location": "",
        "notes": "SKU SLVHLMSHR-0002",
        "image_url": ""
      },
      {
        "id": "GU-JAPSP",
        "name": "Jelly Aurora Pigment Sample Pack",
        "vendor": "Glitter Unique",
        "category": "Pigment",
        "finish": "Iridescent",
        "color": "Mixed",
        "particle_size_microns": "",
        "solvent_safe": true,
        "weight_g": null,
        "volume_ml": null,
        "price_usd": null,
        "order_id": "45609",
        "order_date": "2025-08-25",
        "location": "",
        "notes": "Sample pack",
        "image_url": ""
      },

      /* --------- SPECTRAFLAIR4U (your previous list) --------- */
      { "id":"SF-STK27","name":"Holographic Geometric Pigment .002×.002 — Silver (STK27)","vendor":"Spectraflair4U","category":"Glitter","finish":"Holographic","color":"Silver","particle_size_microns":"≈50","solvent_safe":true,"weight_g":5,"volume_ml":null,"price_usd":null,"order_id":"AFOC-412538","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"SF-STK28","name":"Holographic Geometric Pigment .002×.002 — Gold (STK28)","vendor":"Spectraflair4U","category":"Glitter","finish":"Holographic","color":"Gold","particle_size_microns":"≈50","solvent_safe":true,"weight_g":5,"volume_ml":null,"price_usd":null,"order_id":"AFOC-412538","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"SF-STK29","name":"Clear Holographic Geometric Pigment .008×.008 — 1/2 oz (STK29)","vendor":"Spectraflair4U","category":"Glitter","finish":"Holographic","color":"Clear","particle_size_microns":"","solvent_safe":true,"weight_g":null,"volume_ml":null,"price_usd":null,"order_id":"AFOC-412538","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"SF-STK30","name":"Clear Holographic Geometric Pigment .004×.004 — 1/2 oz (STK30)","vendor":"Spectraflair4U","category":"Glitter","finish":"Holographic","color":"Clear","particle_size_microns":"","solvent_safe":true,"weight_g":null,"volume_ml":null,"price_usd":null,"order_id":"AFOC-412538","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"SF-NRG8-1","name":"Neon Round Dots .8mm — White (NRG.8-1) / 5 g","vendor":"Spectraflair4U","category":"Glitter","finish":"Neon","color":"White","particle_size_microns":"","solvent_safe":true,"weight_g":5,"volume_ml":null,"price_usd":null,"order_id":"AFOC-412538","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"SF-NRG8-10","name":"Neon Round Dots .8mm — Fuchsia (NRG.8-10) / 5 g","vendor":"Spectraflair4U","category":"Glitter","finish":"Neon","color":"Fuchsia","particle_size_microns":"","solvent_safe":true,"weight_g":5,"volume_ml":null,"price_usd":null,"order_id":"AFOC-412538","order_date":"2025-08-24","location":"","notes":"","image_url":"" },

      /* --------- TECHNOGLOW --------- */
      { "id":"TG-invisible-purple-1_2oz","name":"Invisible Purple Glow in the Dark & UV Powder — 35 µm","vendor":"Techno Glow","category":"Pigment","finish":"Glow/UV","color":"Invisible Purple","particle_size_microns":"35","solvent_safe":true,"weight_g":14.17475,"volume_ml":null,"price_usd":null,"order_id":"199738","order_date":"2025-08-24","location":"","notes":"1/2 oz","image_url":"" },
      { "id":"TG-fluoro-yellow-green-1_2oz","name":"Fluorescent Yellow-Green Glow in the Dark & UV Powder — 35 µm","vendor":"Techno Glow","category":"Pigment","finish":"Glow/UV","color":"Yellow-Green","particle_size_microns":"35","solvent_safe":true,"weight_g":14.17475,"volume_ml":null,"price_usd":null,"order_id":"199738","order_date":"2025-08-24","location":"","notes":"1/2 oz","image_url":"" },
      { "id":"TG-fluoro-orange-1_2oz","name":"Fluorescent Orange Glow in the Dark & UV Powder — 35 µm","vendor":"Techno Glow","category":"Pigment","finish":"Glow/UV","color":"Orange","particle_size_microns":"35","solvent_safe":true,"weight_g":14.17475,"volume_ml":null,"price_usd":null,"order_id":"199738","order_date":"2025-08-24","location":"","notes":"1/2 oz (x2 ordered)","image_url":"" },
      { "id":"TG-fluoro-pink-to-rust-1_2oz","name":"Fluorescent Pink→Rust Glow in the Dark & UV Powder — 35 µm","vendor":"Techno Glow","category":"Pigment","finish":"Glow/UV","color":"Pink→Rust","particle_size_microns":"35","solvent_safe":true,"weight_g":14.17475,"volume_ml":null,"price_usd":null,"order_id":"199738","order_date":"2025-08-24","location":"","notes":"1/2 oz","image_url":"" },
      { "id":"TG-green-zns-1_2oz","name":"Green Glow in the Dark & UV Powder — Zinc Sulfide","vendor":"Techno Glow","category":"Pigment","finish":"Glow","color":"Green (ZnS)","particle_size_microns":"","solvent_safe":true,"weight_g":14.17475,"volume_ml":null,"price_usd":null,"order_id":"199738","order_date":"2025-08-24","location":"","notes":"1/2 oz","image_url":"" },

      /* --------- SOLARCOLORDUST --------- */
      { "id":"SCD-AngelHolo-1g","name":"Angel Holo™ — Clear Holographic Powder","vendor":"SolarColorDust","category":"Pigment","finish":"Holographic","color":"Clear Holo","particle_size_microns":"","solvent_safe":true,"weight_g":1,"volume_ml":null,"price_usd":null,"order_id":"48820","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"SCD-KS-Zephyr","name":"KaleidoShift® — Zephyr","vendor":"SolarColorDust","category":"Pigment","finish":"Color Shift","color":"Blue/Green/Purple","particle_size_microns":"","solvent_safe":true,"weight_g":null,"volume_ml":null,"price_usd":null,"order_id":"48820","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"SCD-KS-Cosmos","name":"KaleidoShift® — Cosmos","vendor":"SolarColorDust","category":"Pigment","finish":"Color Shift","color":"Color Shift","particle_size_microns":"","solvent_safe":true,"weight_g":null,"volume_ml":null,"price_usd":null,"order_id":"48820","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"SCD-ED-Splendor","name":"Ethereal Dust — Splendor","vendor":"SolarColorDust","category":"Pigment","finish":"Chameleon","color":"Ethereal","particle_size_microns":"","solvent_safe":true,"weight_g":null,"volume_ml":null,"price_usd":null,"order_id":"48820","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"SCD-ED-Aerial","name":"Ethereal Dust — Aerial","vendor":"SolarColorDust","category":"Pigment","finish":"Chameleon","color":"Ethereal","particle_size_microns":"","solvent_safe":true,"weight_g":null,"volume_ml":null,"price_usd":null,"order_id":"48820","order_date":"2025-08-24","location":"","notes":"","image_url":"" },

      /* --------- JUST PIGMENTS --------- */
      { "id":"JP-OMPT-CS","name":"Orange Magenta Purple Super Color Shift (Chameleon) — Sample","vendor":"Just Pigments","category":"Pigment","finish":"Chameleon","color":"Orange/Magenta/Purple","particle_size_microns":"","solvent_safe":true,"weight_g":2,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"Sample","image_url":"" },
      { "id":"JP-OMT-CS","name":"Orange Magenta Teal Super Color Shift (Chameleon) — Sample","vendor":"Just Pigments","category":"Pigment","finish":"Chameleon","color":"Orange/Magenta/Teal","particle_size_microns":"","solvent_safe":true,"weight_g":2,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"Sample","image_url":"" },
      { "id":"JP-BGY-CS","name":"Blue Green Yellow Super Color Shift (Chameleon) — Sample","vendor":"Just Pigments","category":"Pigment","finish":"Chameleon","color":"Blue/Green/Yellow","particle_size_microns":"","solvent_safe":true,"weight_g":2,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"Sample","image_url":"" },
      { "id":"JP-FineWhiteSatin-30g","name":"Fine White Satin","vendor":"Just Pigments","category":"Pigment","finish":"Satin","color":"White","particle_size_microns":"5–25","solvent_safe":true,"weight_g":30,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"JP-Satin-Gold-2g","name":"Satin Gold — Sample","vendor":"Just Pigments","category":"Pigment","finish":"Satin","color":"Gold","particle_size_microns":"","solvent_safe":true,"weight_g":2,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"Sample","image_url":"" },
      { "id":"JP-Satin-Blue-2g","name":"Satin Blue — Sample","vendor":"Just Pigments","category":"Pigment","finish":"Satin","color":"Blue","particle_size_microns":"","solvent_safe":true,"weight_g":2,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"Sample","image_url":"" },
      { "id":"JP-Satin-Green-2g","name":"Satin Green — Sample","vendor":"Just Pigments","category":"Pigment","finish":"Satin","color":"Green","particle_size_microns":"","solvent_safe":true,"weight_g":2,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"Sample","image_url":"" },
      { "id":"JP-Satin-Red-2g","name":"Satin Red — Sample","vendor":"Just Pigments","category":"Pigment","finish":"Satin","color":"Red","particle_size_microns":"","solvent_safe":true,"weight_g":2,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"Sample","image_url":"" },
      { "id":"JP-Satin-Violet-2g","name":"Satin Violet — Sample","vendor":"Just Pigments","category":"Pigment","finish":"Satin","color":"Violet","particle_size_microns":"","solvent_safe":true,"weight_g":2,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"Sample","image_url":"" },
      { "id":"JP-Brown-FeOx-30g","name":"Brown Iron Oxide (L)","vendor":"Just Pigments","category":"Pigment","finish":"—","color":"Brown","particle_size_microns":"","solvent_safe":true,"weight_g":30,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"JP-Yellow-FeOx-30g","name":"Yellow Iron Oxide","vendor":"Just Pigments","category":"Pigment","finish":"—","color":"Yellow","particle_size_microns":"","solvent_safe":true,"weight_g":30,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"JP-Red-FeOx-30g","name":"Red Iron Oxide (R)","vendor":"Just Pigments","category":"Pigment","finish":"—","color":"Red","particle_size_microns":"","solvent_safe":true,"weight_g":30,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"","image_url":"" },
      { "id":"JP-Manganese-Violet-2g","name":"Manganese Violet — Sample","vendor":"Just Pigments","category":"Pigment","finish":"—","color":"Violet","particle_size_microns":"","solvent_safe":true,"weight_g":2,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"Sample","image_url":"" },
      { "id":"JP-DCRed27-2g","name":"D&C Red #27 Aluminum Lake — Sample","vendor":"Just Pigments","category":"Pigment","finish":"—","color":"Red","particle_size_microns":"","solvent_safe":true,"weight_g":2,"volume_ml":null,"price_usd":null,"order_id":"54021","order_date":"2025-08-24","location":"","notes":"Sample","image_url":"" }
    ];
  </script>

  <script>
    // === App logic (search, multi-filters, sort, KPIs, $/g) ===
    function $(s){ return document.querySelector(s); }
    function fmtUSD(n){ return isFinite(n) ? "$" + n.toFixed(2) : "—"; }
    function parseNum(v){ return (v===null || v==="" || typeof v==="undefined") ? null : Number(v); }
    function uniq(arr){
      var m = {}, out = [], i;
      for(i=0;i<arr.length;i++){ var k = String(arr[i]||""); if(k && !m[k]){ m[k]=1; out.push(k); } }
      out.sort(function(a,b){ return String(a).localeCompare(String(b)); });
      return out;
    }
    function costPerGram(item){
      var price = parseNum(item.price_usd);
      var g = parseNum(item.weight_g);
      if(price!==null && g!==null && g>0) return price / g;
      return null;
    }

    var DB = Array.isArray(window.__INV__) ? window.__INV__ : [];
    var state = { q:"", vendor:[], category:[], finish:[], sort:"name" };

    function optionize(select, values, includeAllLabel){
      select.innerHTML = "";
      if (includeAllLabel){
        var allOpt = document.createElement("option");
        allOpt.value = "__ALL__"; allOpt.textContent = includeAllLabel;
        select.appendChild(allOpt);
      }
      for(var i=0;i<values.length;i++){
        var opt = document.createElement("option");
        opt.value = values[i]; opt.textContent = values[i];
        select.appendChild(opt);
      }
    }
    function populateFilters(){
      var vendors = uniq(DB.map(function(x){return x.vendor;}).filter(Boolean));
      var cats = uniq(DB.map(function(x){return x.category;}).filter(Boolean));
      var fins = uniq(DB.map(function(x){return x.finish;}).filter(Boolean));
      optionize($("#vendor"), vendors, "All vendors");
      optionize($("#category"), cats);
      optionize($("#finish"), fins);
    }
    function normalize(str){ return (str||"").toString().toLowerCase(); }

    function filterDB(){
      var q = normalize(state.q);
      var rows = DB.filter(function(it){
        var hay = [it.name,it.vendor,it.category,it.finish,it.color,it.particle_size_microns,it.order_id,it.notes].map(normalize).join(" ");
        var matchQ = !q || hay.indexOf(q) !== -1;
        var matchVendor = !state.vendor.length || state.vendor.indexOf(it.vendor) !== -1;
        var matchCat = !state.category.length || state.category.indexOf(it.category) !== -1;
        var matchFin = !state.finish.length || state.finish.indexOf(it.finish) !== -1;
        return matchQ && matchVendor && matchCat && matchFin;
      });
      rows.sort(function(a,b){
        if(state.sort==='name') return String(a.name).localeCompare(String(b.name));
        if(state.sort==='cpgram_asc') return (costPerGram(a)||Infinity) - (costPerGram(b)||Infinity);
        if(state.sort==='cpgram_desc') return (costPerGram(b)||-Infinity) - (costPerGram(a)||-Infinity);
        if(state.sort==='date_desc') return String(b.order_date||"").localeCompare(String(a.order_date||""));
        if(state.sort==='date_asc') return String(a.order_date||"").localeCompare(String(b.order_date||""));
        return 0;
      });
      return rows;
    }

    function totalSpend(rows){ var s=0,i; for(i=0;i<rows.length;i++){ s += parseNum(rows[i].price_usd) || 0; } return s; }
    function totalWeight(rows){ var s=0,i; for(i=0;i<rows.length;i++){ s += parseNum(rows[i].weight_g) || 0; } return s; }

    function render(){
      var grid = $("#grid");
      grid.innerHTML = "";
      var data = filterDB();
      $("#count").textContent = data.length + " item" + (data.length!==1?'s':'');
      // KPIs
      var spend = totalSpend(data);
      var wt = totalWeight(data);
      var i, cpgSum=0, cpgCount=0, c;
      for(i=0;i<data.length;i++){ c = costPerGram(data[i]); if(c!==null){ cpgSum+=c; cpgCount++; } }
      var avg = cpgCount ? (cpgSum / cpgCount) : 0;
      $("#kpi_total_items").textContent = "Total items: " + data.length;
      $("#kpi_total_cost").textContent = "Total spend: " + fmtUSD(spend);
      $("#kpi_total_weight").textContent = "Total weight: " + wt.toFixed(2) + " g";
      $("#kpi_avg_cpg").textContent = "Avg $/g: " + (isFinite(avg) ? "$" + avg.toFixed(2) : "—");

      if(!data.length){
        var empty = document.createElement("div");
        empty.className = "meta";
        empty.textContent = "No items match your filters.";
        grid.appendChild(empty);
        return;
      }

      for(i=0;i<data.length;i++){
        var item = data[i];
        var card = document.createElement("article"); card.className = "card";
        var imgwrap = document.createElement("div"); imgwrap.className="imgwrap";
        if(item.image_url){
          var img = document.createElement("img"); img.loading="lazy"; img.alt=(item.vendor||"")+" — "+(item.name||""); img.src=item.image_url;
          imgwrap.appendChild(img);
        } else {
          imgwrap.textContent = "no image";
        }
        var body = document.createElement("div"); body.className="card-body";
        var name = document.createElement("h3"); name.className="name"; name.textContent = item.name || "(Unnamed)";
        var meta = document.createElement("div"); meta.className="meta";
        meta.textContent = (item.vendor||"Unknown") + " • " + (item.category||"") + (item.finish?(" • " + item.finish):"");

        var chips = document.createElement("div"); chips.className="chips";
        if(item.color){ var s=document.createElement("span"); s.className="chip"; s.textContent=item.color; chips.appendChild(s); }
        if(item.particle_size_microns){ var s2=document.createElement("span"); s2.className="chip"; s2.textContent=String(item.particle_size_microns) + "µm"; chips.appendChild(s2); }
        if(item.solvent_safe===true){ var s3=document.createElement("span"); s3.className="chip"; s3.textContent="Solvent-safe"; chips.appendChild(s3); }

        var cpg = costPerGram(item);
        var price = document.createElement("div"); price.className="price";
        var parts = [];
        if(item.weight_g){ parts.push(String(item.weight_g) + " g"); }
        if(item.volume_ml){ parts.push(String(item.volume_ml) + " ml"); }
        if(item.price_usd!==null && typeof item.price_usd!=="undefined"){ parts.push(fmtUSD(Number(item.price_usd))); } else { parts.push("—"); }
        if(cpg!==null){ parts.push("$" + cpg.toFixed(2) + "/g"); } else { parts.push("$/g N/A"); }
        price.innerHTML = parts.join(" · ");

        body.appendChild(name); body.appendChild(meta); body.appendChild(chips); body.appendChild(price);
        card.appendChild(imgwrap); card.appendChild(body); grid.appendChild(card);
      }
    }

    function handleMultiSelect(e, key){
      var opts = e.target.selectedOptions || [];
      var values = [];
      var sawAll = false;
      for(var i=0;i<opts.length;i++){
        if(opts[i].value === "__ALL__") { sawAll = true; break; }
        values.push(opts[i].value);
      }
      if(sawAll){
        // Treat "All vendors" as no filter
        e.target.selectedIndex = -1; // clear visual selection
        state[key] = [];
      } else {
        state[key] = values;
      }
      render();
    }

    function clearFilters(){
      state.q=""; state.vendor=[]; state.category=[]; state.finish=[];
      $("#q").value="";
      ["#vendor","#category","#finish"].forEach(function(id){ document.querySelector(id).selectedIndex=-1; });
      $("#sort").value="name"; state.sort="name";
      render();
    }

    function initEvents(){
      $("#q").addEventListener("input", function(e){ state.q=e.target.value; render(); });
      document.querySelector("#vendor").addEventListener("change", function(e){ handleMultiSelect(e,"vendor"); });
      document.querySelector("#category").addEventListener("change", function(e){ handleMultiSelect(e,"category"); });
      document.querySelector("#finish").addEventListener("change", function(e){ handleMultiSelect(e,"finish"); });
      $("#sort").addEventListener("change", function(e){ state.sort=e.target.value; render(); });
      $("#clear").addEventListener("click", clearFilters);
    }

    (function init(){
      var vendors = uniq((window.__INV__||[]).map(function(x){return x.vendor;}).filter(Boolean));
      var cats = uniq((window.__INV__||[]).map(function(x){return x.category;}).filter(Boolean));
      var fins = uniq((window.__INV__||[]).map(function(x){return x.finish;}).filter(Boolean));
      optionize(document.querySelector("#vendor"), vendors, "All vendors");
      optionize(document.querySelector("#category"), cats);
      optionize(document.querySelector("#finish"), fins);
      initEvents();
      render();
    })();
  </script>
</body>
</html>
